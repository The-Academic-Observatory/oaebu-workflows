-- The purpose of this block of SQL is to organise the metrics from IRUS Fulcrum for easier consumption of downstream queries.
-- Defined in the create_oaebu_book_product_table method, in onix_workflow.py, is the value of 'irus_fulcrum_table_id'.
-- This will either point to 'empty_irus_fulcrum' (defined above as an empty row) or the name of the real data table in bigquery.
-- The reason for the choice of selecting an empty row, is that some partners will not have corresponding data to query.
-- Providng an empty row enable simplicity of the downstream queries and also means the resulting schema across all publishers is the same.
irus_fulcrum_metrics as (
    SELECT
        ISBN as ISBN13,
        release_date,
        STRUCT(
            SUM(total_item_investigations) as total_item_investigations,
            SUM(total_item_requests) as total_item_requests,
            SUM(unique_item_investigations) as unique_item_investigations,
            SUM(unique_item_requests) as unique_item_requests,
            group_items_irus_fulcrum_country(ARRAY_CONCAT_AGG(country)) as country
        ) as metrics
    FROM
        `{{ irus_fulcrum_table_id }}`
    GROUP BY
        ISBN,
        release_date
),
-- The purpose of this block of SQL is to organise the Metadata from IRUS OAPEN for easier consumption of downstream queries.
-- Defined in the create_oaebu_book_product_table method, in onix_workflow.py, is the value of 'irus_fulcrum_table_id'.
-- This will either point to 'empty_irus_oapen' (defined above as an empty row) or the name of the real data table in bigquery.
-- The reason for the choice of selecting an empty row, is that some partners will not have corresponding data to query.
-- Providng an empty row enable simplicity of the downstream queries and also means the resulting schema across all publishers is the same.
irus_fulcrum_metadata as (
    SELECT
        ISBN as ISBN13,
        MAX(book_title) as book_title,
        MAX(publisher) as publisher
    FROM
        `{{ irus_fulcrum_table_id }}`
    GROUP BY
        ISBN
)